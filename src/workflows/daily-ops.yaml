# Daily Operations Workflow
# AgentWorkflow ã«ã‚ˆã‚‹ daily_ops ã®è‡ªå‹•åŒ–å®šç¾©

name: daily-ops
description: ãƒ‡ã‚¤ãƒªãƒ¼ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ - Voicyå–å¾—ã‹ã‚‰Note.comæŠ•ç¨¿ã¾ã§
version: 1.0.0

# ãƒˆãƒªã‚¬ãƒ¼
triggers:
  - schedule: "0 9 * * *"  # æ¯æœ9æ™‚ (JST)
  - manual: true
  - label: "workflow:daily-ops"

# ç’°å¢ƒå¤‰æ•°
env:
  GEMINI_API_KEY: ${GEMINI_API_KEY}
  GITHUB_TOKEN: ${GITHUB_TOKEN}
  VOICEVOX_HOST: "http://localhost:50021"
  OBSIDIAN_VAULT: "/Users/shunsukehayashi/Documents/AI-Course-Generator"
  DAILY_OPS_PATH: "/Users/shunsukehayashi/dev/daily_ops"

# ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®šç¾©
stages:
  # Stage 1: Collector
  - name: collect
    agent: collector
    timeout: 300  # 5åˆ†
    steps:
      - name: fetch_voicy
        command: |
          cd ${DAILY_OPS_PATH}
          python tools/fetch_voicy_all.py --latest
        output: voicy_content_latest.md
        retry: 3

      - name: validate_content
        condition: file_exists(voicy_content_latest.md)
        on_failure: notify_slack

  # Stage 2: Creator
  - name: create
    agent: creator
    depends_on: collect
    timeout: 600  # 10åˆ†
    steps:
      - name: generate_article
        prompt: |
          voicy_content_latest.md ã‚’ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã§ SEO æœ€é©åŒ–è¨˜äº‹ã«å¤‰æ›:
          - ã‚¿ã‚¤ãƒˆãƒ«: 32-60æ–‡å­—
          - H2/H3 æ§‹é€ 
          - [--IMAGE--] ãƒãƒ¼ã‚«ãƒ¼ 3-5å€‹
          - CTA ãƒ–ãƒ­ãƒƒã‚¯å«ã‚€
        output: note_draft_${DATE}.md

      - name: generate_infographic
        command: |
          cd ${DAILY_OPS_PATH}
          python tools/gemini-image/infographic.py \
            --input note_draft_${DATE}.md \
            --style whiteboard \
            --count 3
        output: assets/images/

      - name: prepare_job
        command: |
          cd ${DAILY_OPS_PATH}
          python -c "
          import json
          with open('note_draft_${DATE}.md') as f:
              content = f.read()
          title = content.split('\n')[0].replace('# ', '')
          job = {'title': title, 'body': content, 'images': []}
          with open('miyabi_bridge/job.json', 'w') as f:
              json.dump(job, f, ensure_ascii=False)
          "

  # Stage 3: Archivist
  - name: archive
    agent: archivist
    depends_on: create
    timeout: 300  # 5åˆ†
    steps:
      - name: sync_obsidian
        command: |
          DATE=$(date +%Y-%m-%d)
          VAULT="${OBSIDIAN_VAULT}"

          # Voicy åŒæœŸ
          mkdir -p "${VAULT}/Inbox/Voicy"
          cp voicy_content_latest.md "${VAULT}/Inbox/Voicy/${DATE}_voicy.md"

          # Draft åŒæœŸ
          mkdir -p "${VAULT}/Inbox/Drafts/${DATE}"
          cp note_draft_${DATE}.md "${VAULT}/Inbox/Drafts/${DATE}/"

          # Daily Note ä½œæˆ
          mkdir -p "${VAULT}/Daily"
          cat > "${VAULT}/Daily/${DATE}.md" << EOF
          ---
          date: ${DATE}
          tags: [daily, voicy, note]
          status: completed
          ---

          # ${DATE} Daily Operations

          ## Voicy
          - [[Inbox/Voicy/${DATE}_voicy]]

          ## Drafts
          - [[Inbox/Drafts/${DATE}/note_draft_${DATE}]]

          ## Status
          - [x] Voicy å–å¾—
          - [x] è¨˜äº‹ç”Ÿæˆ
          - [x] Obsidian åŒæœŸ
          EOF

      - name: notify_completion
        command: |
          # VOICEVOX é€šçŸ¥ (åˆ©ç”¨å¯èƒ½ãªå ´åˆ)
          if curl -s ${VOICEVOX_HOST}/version > /dev/null 2>&1; then
            TEXT="ãƒ‡ã‚¤ãƒªãƒ¼ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ã—ã¾ã—ãŸ"
            curl -s -X POST "${VOICEVOX_HOST}/audio_query?speaker=1&text=${TEXT}" \
              -o query.json
            curl -s -X POST "${VOICEVOX_HOST}/synthesis?speaker=1" \
              -H "Content-Type: application/json" \
              -d @query.json > output.wav
            afplay output.wav 2>/dev/null || true
          fi
        optional: true

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
on_failure:
  - notify:
      channel: slack
      message: "Daily Ops å¤±æ•—: ${STAGE_NAME} - ${ERROR_MESSAGE}"
  - label:
      add: "state:blocked"
      remove: "state:implementing"

# æˆåŠŸæ™‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
on_success:
  - label:
      add: "state:done"
  - comment: |
      ## âœ… Daily Operations å®Œäº†

      - Voicy å–å¾—: âœ“
      - è¨˜äº‹ç”Ÿæˆ: âœ“
      - Obsidian åŒæœŸ: âœ“

      ğŸ“ ãƒ‰ãƒ©ãƒ•ãƒˆ: `note_draft_${DATE}.md`
      ğŸ“ Vault: `${OBSIDIAN_VAULT}/Daily/${DATE}.md`

# ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
metadata:
  created: 2024-12-31
  author: AgentWorkflow
  source: daily_ops
  labels:
    - "âœ¨ type:feature"
    - "âš ï¸ priority:P1-High"
    - "ğŸ¤– agent:coordinator"
